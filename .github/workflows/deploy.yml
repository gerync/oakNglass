#region Metadata
name: "Deploy OakNGlass Backend"

on:
#endregion
  push:
    branches: [ auto-deployment ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      #region Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      #endregion

      #region Cloudflared
      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
      #endregion

      #region SSHConfig
      - name: Setup Secure SSH Environment
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          ssh-keyscan -t rsa,ecdsa,ed25519 ssh.gerync.com >> ~/.ssh/known_hosts 2>/dev/null || true
          
          cat <<EOF > ~/.ssh/config
          Host ssh.gerync.com
            ProxyCommand cloudflared access ssh --hostname %h --service-token-id ${{ secrets.CF_CLIENT_ID }} --service-token-secret ${{ secrets.CF_CLIENT_SECRET }}
            Port 9700
            StrictHostKeyChecking accept-new
          EOF
          
          chmod 600 ~/.ssh/config
      #endregion

      #region RemoteDeploy
      - name: Execute Remote Deployment
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh -i ~/.ssh/id_ed25519 gery@ssh.gerync.com -p 9700 << 'EOF'
            set -e
            cd /home/gery/Repos/oakNglass
            git pull origin auto-deployment
            cd backend

            umask 077
            cat > config.json <<EOF
            {
              "backend": { "host": "${BACKEND_HOST:-0.0.0.0}", "port": ${BACKEND_PORT:-8080} },
              "isProduction": true,
              "frontend": { "host": "${FRONTEND_HOST:-localhost}", "port": ${FRONTEND_PORT:-3000} },
              "database": {
                  "host": "${DB_HOST}",
                  "port": ${DB_PORT:-5432},
                  "username": "${DB_USER}",
                  "password": "${DB_PASS}",
                  "dbname": "${DB_NAME}",
                  "maxConnections": ${DB_MAX_CONN:-20},
                  "ssl": ${DB_SSL:-false}
              },
              "email": {
                  "smtpHost": "${SMTP_HOST}",
                  "smtpPort": ${SMTP_PORT:-587},
                  "auth": { "user": "${SMTP_USER}", "pass": "${SMTP_PASS}" },
                  "alias": { "name": "${EMAIL_ALIAS_NAME:-Oak N Glass}", "address": "${EMAIL_ALIAS_ADDRESS:-no-reply@oak.example.com}" },
                  "codesExpiry": ${EMAIL_CODES_EXPIRY:-360000000}
              },
              "security": {
                "tokenExpiry": {
                  "access": "${TOKEN_ACCESS:-30m}",
                  "refresh": "${TOKEN_REFRESH:-30d}",
                  "resetPassword": "${TOKEN_RESET:-30m}"
                },
                "secrets": {
                  "jwt": "${JWT_SECRET}",
                  "cookies": "${COOKIE_SECRET}",
                  "encryption": "${ENCRYPTION_SECRET}",
                  "salt": "${SALT_SECRET}"
                }
              },
              "CDN": {
                "url": "${CDN_URL}",
                "apiKey": "${CDN_KEY}"
              }
            }
            EOF

            docker build --pull -t oaknglass-backend:latest .
            docker stop oaknglass || true
            docker rm oaknglass || true
            docker run -d --name oaknglass -p 8080:8080 oaknglass-backend:latest
          EOF