#region Metadata
name: "Deploy OakNGlass Backend"

on:
#endregion
  push:
    branches: [ auto-deployment ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      #region Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      #endregion

      #region Cloudflared
      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
      #endregion

      #region SSHConfig
      - name: Setup Secure SSH Environment
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Use your secrets to authenticate the tunnel
          cat <<EOF > ~/.ssh/config
          Host ${{ secrets.SERVER_HOST }}
            ProxyCommand cloudflared access ssh --hostname %h --service-token-id ${{ secrets.CF_CLIENT_ID }} --service-token-secret ${{ secrets.CF_CLIENT_SECRET }}
          EOF
          
          # Add your server to known_hosts to prevent "Host key verification failed"
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      #endregion

      #region RemoteDeploy
      - name: Execute Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
          ENCRYPTION_SECRET: ${{ secrets.ENCRYPTION_SECRET }}
          SALT_SECRET: ${{ secrets.SALT_SECRET }}
          CDN_URL: ${{ secrets.CDN_URL }}
          CDN_KEY: ${{ secrets.CDN_KEY }}
          FRONTEND_HOST: ${{ secrets.FRONTEND_HOST }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}
          BACKEND_HOST: ${{ secrets.BACKEND_HOST }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
          DB_MAX_CONN: ${{ secrets.DB_MAX_CONN }}
          DB_SSL: ${{ secrets.DB_SSL }}
          EMAIL_ALIAS_NAME: ${{ secrets.EMAIL_ALIAS_NAME }}
          EMAIL_ALIAS_ADDRESS: ${{ secrets.EMAIL_ALIAS_ADDRESS }}
          EMAIL_CODES_EXPIRY: ${{ secrets.EMAIL_CODES_EXPIRY }}
          TOKEN_ACCESS: ${{ secrets.TOKEN_ACCESS }}
          TOKEN_REFRESH: ${{ secrets.TOKEN_REFRESH }}
          TOKEN_RESET: ${{ secrets.TOKEN_RESET }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          envs: DB_HOST,DB_PORT,DB_USER,DB_PASS,DB_NAME,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASS,JWT_SECRET,COOKIE_SECRET,ENCRYPTION_SECRET,SALT_SECRET,CDN_URL,CDN_KEY,FRONTEND_HOST,FRONTEND_PORT,BACKEND_HOST,BACKEND_PORT,DB_MAX_CONN,DB_SSL,EMAIL_ALIAS_NAME,EMAIL_ALIAS_ADDRESS,EMAIL_CODES_EXPIRY,TOKEN_ACCESS,TOKEN_REFRESH,TOKEN_RESET
          script: |
            set -e

            cd /home/${{ secrets.SERVER_USER }}/Repos/oakNglass
            git pull origin auto-deployment

            cd backend

            umask 077
            cat > config.json <<EOF
            {
              "backend": { "host": "${BACKEND_HOST:-0.0.0.0}", "port": ${BACKEND_PORT:-8080} },
              "isProduction": true,
              "frontend": { "host": "${FRONTEND_HOST:-localhost}", "port": ${FRONTEND_PORT:-3000} },
              "database": {
                  "host": "${DB_HOST}",
                  "port": ${DB_PORT:-5432},
                  "username": "${DB_USER}",
                  "password": "${DB_PASS}",
                  "dbname": "${DB_NAME}",
                  "maxConnections": ${DB_MAX_CONN:-20},
                  "ssl": ${DB_SSL:-false}
              },
              "email": {
                  "smtpHost": "${SMTP_HOST}",
                  "smtpPort": ${SMTP_PORT:-587},
                  "auth": { "user": "${SMTP_USER}", "pass": "${SMTP_PASS}" },
                  "alias": { "name": "${EMAIL_ALIAS_NAME:-Oak N Glass}", "address": "${EMAIL_ALIAS_ADDRESS:-no-reply@oak.example.com}" },
                  "codesExpiry": ${EMAIL_CODES_EXPIRY:-360000000}
              },
              "security": {
                "tokenExpiry": {
                  "access": "${TOKEN_ACCESS:-30m}",
                  "refresh": "${TOKEN_REFRESH:-30d}",
                  "resetPassword": "${TOKEN_RESET:-30m}"
                },
                "secrets": {
                  "jwt": "${JWT_SECRET}",
                  "cookies": "${COOKIE_SECRET}",
                  "encryption": "${ENCRYPTION_SECRET}",
                  "salt": "${SALT_SECRET}"
                }
              },
              "CDN": {
                "url": "${CDN_URL}",
                "apiKey": "${CDN_KEY}"
              }
            }
            EOF

            docker build --pull -t oaknglass-backend:latest .

            docker stop oaknglass || true
            docker rm oaknglass || true

            docker run -d \
              --name oaknglass \
              --restart unless-stopped \
              -p ${BACKEND_PORT:-8080}:${BACKEND_PORT:-8080} \
              -v $(pwd)/config.json:/app/config.json:ro \
              oaknglass-backend:latest

            sleep 5
            curl --fail http://localhost:${BACKEND_PORT:-8080}/ || exit 1
      #endregion