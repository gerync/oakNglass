#region Metadata
name: "Deploy OakNGlass Backend"
on:
#endregion
  push:
    branches: [ auto-deployment ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      #region Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      #endregion

      #region Cloudflared
      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
      #endregion

      #region SSHConfig
      - name: Setup Secure SSH Environment
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          CF_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          # Debug: Check if variables are set
          echo "Checking environment variables..."
          if [ -z "$SERVER_USER" ]; then
            echo "ERROR: SERVER_USER is not set!"
            exit 1
          fi
          echo "SERVER_USER is set (length: ${#SERVER_USER})"
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH private key
          printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Create SSH config with proper variable substitution
          printf "Host deployment-server\n" > ~/.ssh/config
          printf "  HostName ssh.gerync.com\n" >> ~/.ssh/config
          printf "  User %s\n" "$SERVER_USER" >> ~/.ssh/config
          printf "  IdentityFile ~/.ssh/id_ed25519\n" >> ~/.ssh/config
          printf "  ProxyCommand cloudflared access ssh --hostname ssh.gerync.com --service-token-id %s --service-token-secret %s\n" "$CF_CLIENT_ID" "$CF_CLIENT_SECRET" >> ~/.ssh/config
          printf "  StrictHostKeyChecking accept-new\n" >> ~/.ssh/config
          printf "  UserKnownHostsFile ~/.ssh/known_hosts\n" >> ~/.ssh/config
          
          chmod 600 ~/.ssh/config
          
          # Debug: Show config (masking secrets)
          echo "=== SSH Config (secrets masked) ==="
          sed 's/--service-token-id [^ ]*/--service-token-id ***/' ~/.ssh/config | sed 's/--service-token-secret [^ ]*/--service-token-secret ***/'
          echo "==================================="
      #endregion

      #region PrepareDeploymentScript
      - name: Prepare Deployment Script
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          if [ -z "$SERVER_USER" ]; then
            echo "ERROR: SERVER_USER is not set in Prepare step!"
            exit 1
          fi
          
          cat > /tmp/deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e
          
          echo "Starting deployment..."
          
          cd /home/SERVER_USER_PLACEHOLDER/Repos/oakNglass
          git pull origin auto-deployment
          
          cd backend
          
          umask 077
          cat > config.json << 'CONFIGEOF'
          {
            "backend": { "host": "BACKEND_HOST_PLACEHOLDER", "port": BACKEND_PORT_PLACEHOLDER },
            "isProduction": true,
            "frontend": { "host": "FRONTEND_HOST_PLACEHOLDER", "port": FRONTEND_PORT_PLACEHOLDER },
            "database": {
                "host": "DB_HOST_PLACEHOLDER",
                "port": DB_PORT_PLACEHOLDER,
                "username": "DB_USER_PLACEHOLDER",
                "password": "DB_PASS_PLACEHOLDER",
                "dbname": "DB_NAME_PLACEHOLDER",
                "maxConnections": DB_MAX_CONN_PLACEHOLDER,
                "ssl": DB_SSL_PLACEHOLDER
            },
            "email": {
                "smtpHost": "SMTP_HOST_PLACEHOLDER",
                "smtpPort": SMTP_PORT_PLACEHOLDER,
                "auth": { "user": "SMTP_USER_PLACEHOLDER", "pass": "SMTP_PASS_PLACEHOLDER" },
                "alias": { "name": "EMAIL_ALIAS_NAME_PLACEHOLDER", "address": "EMAIL_ALIAS_ADDRESS_PLACEHOLDER" },
                "codesExpiry": EMAIL_CODES_EXPIRY_PLACEHOLDER
            },
            "security": {
              "tokenExpiry": {
                "access": "TOKEN_ACCESS_PLACEHOLDER",
                "refresh": "TOKEN_REFRESH_PLACEHOLDER",
                "resetPassword": "TOKEN_RESET_PLACEHOLDER"
              },
              "secrets": {
                "jwt": "JWT_SECRET_PLACEHOLDER",
                "cookies": "COOKIE_SECRET_PLACEHOLDER",
                "encryption": "ENCRYPTION_SECRET_PLACEHOLDER",
                "salt": "SALT_SECRET_PLACEHOLDER"
              }
            },
            "CDN": {
              "url": "CDN_URL_PLACEHOLDER",
              "apiKey": "CDN_KEY_PLACEHOLDER"
            }
          }
          CONFIGEOF
          
          # Replace placeholders with environment variables
          sed -i "s|BACKEND_HOST_PLACEHOLDER|${BACKEND_HOST:-0.0.0.0}|g" config.json
          sed -i "s|BACKEND_PORT_PLACEHOLDER|${BACKEND_PORT:-8080}|g" config.json
          sed -i "s|FRONTEND_HOST_PLACEHOLDER|${FRONTEND_HOST:-localhost}|g" config.json
          sed -i "s|FRONTEND_PORT_PLACEHOLDER|${FRONTEND_PORT:-3000}|g" config.json
          sed -i "s|DB_HOST_PLACEHOLDER|${DB_HOST}|g" config.json
          sed -i "s|DB_PORT_PLACEHOLDER|${DB_PORT:-5432}|g" config.json
          sed -i "s|DB_USER_PLACEHOLDER|${DB_USER}|g" config.json
          sed -i "s|DB_PASS_PLACEHOLDER|${DB_PASS}|g" config.json
          sed -i "s|DB_NAME_PLACEHOLDER|${DB_NAME}|g" config.json
          sed -i "s|DB_MAX_CONN_PLACEHOLDER|${DB_MAX_CONN:-20}|g" config.json
          sed -i "s|DB_SSL_PLACEHOLDER|${DB_SSL:-false}|g" config.json
          sed -i "s|SMTP_HOST_PLACEHOLDER|${SMTP_HOST}|g" config.json
          sed -i "s|SMTP_PORT_PLACEHOLDER|${SMTP_PORT:-587}|g" config.json
          sed -i "s|SMTP_USER_PLACEHOLDER|${SMTP_USER}|g" config.json
          sed -i "s|SMTP_PASS_PLACEHOLDER|${SMTP_PASS}|g" config.json
          sed -i "s|EMAIL_ALIAS_NAME_PLACEHOLDER|${EMAIL_ALIAS_NAME:-Oak N Glass}|g" config.json
          sed -i "s|EMAIL_ALIAS_ADDRESS_PLACEHOLDER|${EMAIL_ALIAS_ADDRESS:-no-reply@oak.example.com}|g" config.json
          sed -i "s|EMAIL_CODES_EXPIRY_PLACEHOLDER|${EMAIL_CODES_EXPIRY:-360000000}|g" config.json
          sed -i "s|TOKEN_ACCESS_PLACEHOLDER|${TOKEN_ACCESS:-30m}|g" config.json
          sed -i "s|TOKEN_REFRESH_PLACEHOLDER|${TOKEN_REFRESH:-30d}|g" config.json
          sed -i "s|TOKEN_RESET_PLACEHOLDER|${TOKEN_RESET:-30m}|g" config.json
          sed -i "s|JWT_SECRET_PLACEHOLDER|${JWT_SECRET}|g" config.json
          sed -i "s|COOKIE_SECRET_PLACEHOLDER|${COOKIE_SECRET}|g" config.json
          sed -i "s|ENCRYPTION_SECRET_PLACEHOLDER|${ENCRYPTION_SECRET}|g" config.json
          sed -i "s|SALT_SECRET_PLACEHOLDER|${SALT_SECRET}|g" config.json
          sed -i "s|CDN_URL_PLACEHOLDER|${CDN_URL}|g" config.json
          sed -i "s|CDN_KEY_PLACEHOLDER|${CDN_KEY}|g" config.json
          
          echo "Building Docker image..."
          docker build --pull -t oaknglass-backend:latest .
          
          echo "Stopping existing container..."
          docker stop oaknglass 2>/dev/null || true
          docker rm oaknglass 2>/dev/null || true
          
          echo "Starting new container..."
          docker run -d \
            --name oaknglass \
            --restart unless-stopped \
            -p ${BACKEND_PORT:-8080}:${BACKEND_PORT:-8080} \
            -v $(pwd)/config.json:/app/config.json:ro \
            oaknglass-backend:latest
          
          echo "Waiting for container to start..."
          sleep 5
          
          echo "Health check..."
          curl --fail http://localhost:${BACKEND_PORT:-8080}/ || exit 1
          
          echo "Deployment completed successfully!"
          DEPLOYSCRIPT
          
          # Replace SERVER_USER placeholder in the script
          sed -i "s|SERVER_USER_PLACEHOLDER|${SERVER_USER}|g" /tmp/deploy.sh
          
          chmod +x /tmp/deploy.sh
          
          echo "Deployment script prepared for user: $SERVER_USER"
      #endregion

      #region RemoteDeploy
      - name: Execute Remote Deployment
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
          ENCRYPTION_SECRET: ${{ secrets.ENCRYPTION_SECRET }}
          SALT_SECRET: ${{ secrets.SALT_SECRET }}
          CDN_URL: ${{ secrets.CDN_URL }}
          CDN_KEY: ${{ secrets.CDN_KEY }}
          FRONTEND_HOST: ${{ secrets.FRONTEND_HOST }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}
          BACKEND_HOST: ${{ secrets.BACKEND_HOST }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
          DB_MAX_CONN: ${{ secrets.DB_MAX_CONN }}
          DB_SSL: ${{ secrets.DB_SSL }}
          EMAIL_ALIAS_NAME: ${{ secrets.EMAIL_ALIAS_NAME }}
          EMAIL_ALIAS_ADDRESS: ${{ secrets.EMAIL_ALIAS_ADDRESS }}
          EMAIL_CODES_EXPIRY: ${{ secrets.EMAIL_CODES_EXPIRY }}
          TOKEN_ACCESS: ${{ secrets.TOKEN_ACCESS }}
          TOKEN_REFRESH: ${{ secrets.TOKEN_REFRESH }}
          TOKEN_RESET: ${{ secrets.TOKEN_RESET }}
        run: |
          echo "Transferring deployment script..."
          scp -o StrictHostKeyChecking=accept-new -v /tmp/deploy.sh deployment-server:/tmp/deploy.sh
          
          echo "Executing deployment on remote server..."
          ssh -o StrictHostKeyChecking=accept-new -v deployment-server "export \
            DB_HOST='${DB_HOST}' \
            DB_PORT='${DB_PORT}' \
            DB_USER='${DB_USER}' \
            DB_PASS='${DB_PASS}' \
            DB_NAME='${DB_NAME}' \
            SMTP_HOST='${SMTP_HOST}' \
            SMTP_PORT='${SMTP_PORT}' \
            SMTP_USER='${SMTP_USER}' \
            SMTP_PASS='${SMTP_PASS}' \
            JWT_SECRET='${JWT_SECRET}' \
            COOKIE_SECRET='${COOKIE_SECRET}' \
            ENCRYPTION_SECRET='${ENCRYPTION_SECRET}' \
            SALT_SECRET='${SALT_SECRET}' \
            CDN_URL='${CDN_URL}' \
            CDN_KEY='${CDN_KEY}' \
            FRONTEND_HOST='${FRONTEND_HOST}' \
            FRONTEND_PORT='${FRONTEND_PORT}' \
            BACKEND_HOST='${BACKEND_HOST}' \
            BACKEND_PORT='${BACKEND_PORT}' \
            DB_MAX_CONN='${DB_MAX_CONN}' \
            DB_SSL='${DB_SSL}' \
            EMAIL_ALIAS_NAME='${EMAIL_ALIAS_NAME}' \
            EMAIL_ALIAS_ADDRESS='${EMAIL_ALIAS_ADDRESS}' \
            EMAIL_CODES_EXPIRY='${EMAIL_CODES_EXPIRY}' \
            TOKEN_ACCESS='${TOKEN_ACCESS}' \
            TOKEN_REFRESH='${TOKEN_REFRESH}' \
            TOKEN_RESET='${TOKEN_RESET}' && \
            bash /tmp/deploy.sh"
      #endregion